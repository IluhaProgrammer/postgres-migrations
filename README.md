# PostgreSQL Migrations with Flyway (Docker Lab)

## üìå –û–ø–∏—Å–∞–Ω–∏–µ

–î–∞–Ω–Ω–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ—Å–≤—è—â–µ–Ω–∞ **—É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ —Å—Ö–µ–º—ã PostgreSQL** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Flyway** –≤ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–∏.

–¶–µ–ª—å –ª–∞–±—ã ‚Äî –ø–æ–Ω—è—Ç—å, **–∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**, –Ω–µ –ª–æ–º–∞—è –ø—Ä–æ–¥–∞–∫—à–Ω, –∏ –∫–∞–∫ DevOps-–∏–Ω–∂–µ–Ω–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã.

–õ–∞–±–∞ –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç **—Ä–µ–∞–ª—å–Ω—ã–π production-—Å—Ü–µ–Ω–∞—Ä–∏–π**:
- –±–∞–∑–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –≤ –Ω–µ–π –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
- –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ—ç—Ç–∞–ø–Ω–æ
- –∫–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è


## üéØ –¶–µ–ª–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π

- –ü–æ–Ω—è—Ç—å, –∑–∞—á–µ–º –Ω—É–∂–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- –ù–∞—É—á–∏—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Flyway
- –û—Å–≤–æ–∏—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã
- –ü—Ä–∏–º–µ–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (add column, backfill, index concurrently)
- –£–≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –º–∏–≥—Ä–∞—Ü–∏–π: **–∫–æ–¥ ‚Üí –ë–î ‚Üí –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è**


## üß± –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- **PostgreSQL 16** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î
- **Flyway** ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–π
- **Docker Compose** ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è

Flyway –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ SQL-–º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `flyway/sql` –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.


## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
 day9-postgres/
 ‚îú‚îÄ‚îÄ flyway/
 ‚îÇ   ‚îî‚îÄ‚îÄ sql/
 ‚îÇ       ‚îú‚îÄ‚îÄ V1__add_column.sql
 ‚îÇ       ‚îú‚îÄ‚îÄ V2__backfill.sql
 ‚îÇ       ‚îî‚îÄ‚îÄ V3__index_concurrently.sql
 ‚îú‚îÄ‚îÄ docker-compose.yml
 ‚îî‚îÄ‚îÄ README.md
```


## üê≥ Docker Compose

–í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤–∞ —Å–µ—Ä–≤–∏—Å–∞:

### PostgreSQL
- –ë–∞–∑–∞ `prod_db`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `postgres`
- –ü—Ä–µ–¥–Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (`max_connections`, `shared_buffers`)

### Flyway
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `flyway migrate`
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ `/flyway/sql`


## üß™ –•–æ–¥ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã

### 1Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
docker compose up -d
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:
- PostgreSQL –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
- Flyway –∂–¥—ë—Ç –ë–î –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏


### 2Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–í–Ω—É—Ç—Ä–∏ PostgreSQL:
- —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ `users`
- —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

–≠—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç **—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø—Ä–æ–¥–∞–∫—à–Ω-–±–∞–∑—É**, –≤ –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è.


## üóÇ –ú–∏–≥—Ä–∞—Ü–∏–∏

### üîπ V1 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏

**–§–∞–π–ª:** `V1__add_column.sql`

```sql
ALTER TABLE users
ADD COLUMN last_login TIMESTAMP;
```

<img width="476" height="242" alt="image" src="https://github.com/user-attachments/assets/8f974222-2051-46e1-b96f-94ce7db38ca8" />

–£ –Ω–∞—Å –¥–æ–±–∞–≤–∏–ª—Å—è –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü –±–µ–∑ –ª–∏—à–Ω–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### üîπ V2 ‚Äî Backfill –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `V2__backfill.sql`

```sql
UPDATE users
SET last_login = created_at
WHERE last_login IS NULL;
```
<img width="547" height="277" alt="image" src="https://github.com/user-attachments/assets/91a40834-7239-40fd-8da2-8f6a76923231" />

–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤ –ø—É—Å—Ç–æ–π —Å—Ç–æ–ª–±–µ—Ü —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–∏–ª–∏—Å—å

üìå –í–∞–∂–Ω—ã–π –ø—Ä–æ–¥–∞–∫—à–Ω-–ø–∞—Ç—Ç–µ—Ä–Ω:
- –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- —Å—Ö–µ–º–∞ –∏ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—è—é—Ç—Å—è –ø–æ—ç—Ç–∞–ø–Ω–æ


### üîπ V3 ‚Äî –ò–Ω–¥–µ–∫—Å –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–§–∞–π–ª:** `V3__index_concurrently.sql`

```sql
CREATE INDEX CONCURRENTLY idx_users_last_login
ON users (last_login);
```
<img width="556" height="151" alt="image" src="https://github.com/user-attachments/assets/c5b82b72-9270-45b7-98f2-16e0642f936c" />

–ò –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∏–Ω–¥–µ–∫—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–ª—Å—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `CONCURRENTLY`, —á—Ç–æ–±—ã:
- –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
- –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∫—à–Ω-—Ç—Ä–∞—Ñ–∏–∫


## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:

```bash
docker exec -it postgres psql -U postgres prod_db
```

–ü—Ä–æ–≤–µ—Ä–∫–∏:

```sql
\d users;
SELECT COUNT(*) FROM users WHERE last_login IS NULL;
\di
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –∫–æ–ª–æ–Ω–∫–∞ `last_login` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
- –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω


## üß† –ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å

- Flyway —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ `flyway_schema_history`
- –ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:
  - –∏–º–µ–µ—Ç –≤–µ—Ä—Å–∏—é
  - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑
  - –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–∞

–≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç:
- —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ö–µ–º
- —Ä—É—á–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫ –≤ –ë–î
- "—Ä–∞–±–æ—Ç–∞–µ—Ç —É –º–µ–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ"


## üö® Production best practices

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
- –ë–æ–ª—å—à–∏–µ backfill-–æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–µ–ª–∞—Ç—å –±–∞—Ç—á–∞–º–∏
- –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å `CONCURRENTLY`
- –ú–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî —á–∞—Å—Ç—å CI/CD –ø–∞–π–ø–ª–∞–π–Ω–∞


## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–í —Ö–æ–¥–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
- –ø–æ–¥–Ω—è—Ç–∞ PostgreSQL –≤ Docker
- –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î
- –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω production-–ø–æ–¥—Ö–æ–¥ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º —Å—Ö–µ–º—ã
